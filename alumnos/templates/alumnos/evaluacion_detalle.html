<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Examen - Técnica 283</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #003087; color: white; }
        .card { color: black; border-left: 5px solid #FFD100; }
        .btn-boca { background-color: #003087; color: #FFD100; font-weight: bold; }
        /* Estilo para el reloj fijo arriba */
        #reloj-contenedor {
            position: sticky;
            top: 10px;
            z-index: 1000;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <div id="reloj-contenedor">
        <div class="alert alert-warning border-dark shadow text-center">
            <h4 class="mb-0">⏳ Tiempo Restante: <span id="timer">--:--</span></h4>
        </div>
    </div>

    <div class="card shadow p-4 mt-3">
        <h2 class="text-center">{{ evaluacion.titulo }}</h2>
        <div class="alert alert-danger text-center">
            <strong>¡ATENCIÓN!</strong> Si abrís otra pestaña, minimizás el navegador o intentás buscar en Google, 
            el examen se enviará automáticamente con <strong>nota 1</strong>.
        </div>

        <form id="examen_form" method="POST">
            {% csrf_token %}
            <input type="hidden" name="fraude" id="input_fraude" value="false">

            {% for pregunta in evaluacion.preguntas.all %}
            <div class="mb-4 border-bottom pb-3">
                <h5>{{ forloop.counter }}. {{ pregunta.texto }}</h5>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="pregunta_{{ pregunta.id }}" value="A" required>
                    <label class="form-check-label">{{ pregunta.opcion_a }}</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="pregunta_{{ pregunta.id }}" value="B">
                    <label class="form-check-label">{{ pregunta.opcion_b }}</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="pregunta_{{ pregunta.id }}" value="C">
                    <label class="form-check-label">{{ pregunta.opcion_c }}</label>
                </div>
            </div>
            {% endfor %}

            <button type="submit" class="btn btn-boca w-100 py-3">FINALIZAR Y ENTREGAR</button>
        </form>
    </div>
</div>

<script>
    // --- LÓGICA DEL CRONÓMETRO ---
    // Tomamos el tiempo desde la base de datos (por defecto 60 min)
    let tiempoRestante = {{ evaluacion.tiempo_limite }} * 60; 
    const display = document.querySelector('#timer');

    const cuentaRegresiva = setInterval(function () {
        let minutos = parseInt(tiempoRestante / 60, 10);
        let segundos = parseInt(tiempoRestante % 60, 10);

        minutos = minutos < 10 ? "0" + minutos : minutos;
        segundos = segundos < 10 ? "0" + segundos : segundos;

        display.textContent = minutos + ":" + segundos;

        // Si el tiempo llega a cero
        if (--tiempoRestante < 0) {
            clearInterval(cuentaRegresiva);
            alert("¡TIEMPO AGOTADO! Tu examen se enviará automáticamente.");
            document.getElementById("examen_form").submit();
        }
        
        // Ponemos el reloj en rojo si queda menos de 1 minuto
        if (tiempoRestante < 60) {
            display.parentElement.parentElement.classList.replace('alert-warning', 'alert-danger');
        }
    }, 1000);


    // --- EL "VAR" DEL EXAMEN (DETECTOR DE TRAMPAS) ---
    document.addEventListener("visibilitychange", function() {
        if (document.hidden) {
            alert("¡TRAMPA DETECTADA! Saliste de la pestaña. Tu nota final es 1.");
            document.getElementById("input_fraude").value = "true";
            document.getElementById("examen_form").submit();
        }
    });

    // Evitar que usen el botón atrás del navegador
    window.onbeforeunload = function() {
        return "¿Estás seguro de que querés salir? El examen se anulará.";
    };
</script>
</body>
</html>